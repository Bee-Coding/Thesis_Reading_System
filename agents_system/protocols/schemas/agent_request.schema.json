{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://thesis-reading-system.example/schemas/agent_request.schema.json",
  "title": "Agent调用请求",
  "description": "定义Dispatcher调用Agent的标准化请求格式",
  "type": "object",
  "properties": {
    "invocation_id": {
      "type": "string",
      "description": "唯一调用标识符",
      "pattern": "^INV_[0-9]{8}_[0-9]{6}_(SCHOLAR|CODE|VALIDATOR|VAULT|CRITIC)_[0-9]{3}$",
      "examples": [
        "INV_20260203_143052_SCHOLAR_001",
        "INV_20260203_144530_CODE_001"
      ]
    },
    "agent": {
      "type": "string",
      "description": "Agent名称",
      "enum": [
        "Scholar_Internalizer",
        "Code_Architect",
        "Scenario_Validator",
        "Knowledge_Vault",
        "Strategic_Critic"
      ]
    },
    "task_id": {
      "type": "string",
      "description": "关联的任务ID",
      "pattern": "^TASK_(SCHOLAR|CODE|VALIDATOR|VAULT|CRITIC)_[A-Za-z0-9_]+_[0-9]{2}$"
    },
    "plan_id": {
      "type": "string",
      "description": "关联的计划ID",
      "pattern": "^AVP_E2E_[0-9]{8}_[0-9]{3}_(DI|QA|ER|VF)$"
    },
    "system_prompt": {
      "type": "string",
      "description": "Agent的完整System Prompt",
      "minLength": 100
    },
    "user_prompt": {
      "$ref": "#/$defs/user_prompt"
    },
    "constraints": {
      "$ref": "#/$defs/constraints"
    }
  },
  "required": [
    "invocation_id",
    "agent",
    "task_id",
    "plan_id",
    "system_prompt",
    "user_prompt",
    "constraints"
  ],
  "$defs": {
    "user_prompt": {
      "title": "用户提示词",
      "type": "object",
      "properties": {
        "instruction": {
          "type": "string",
          "description": "具体执行指令",
          "minLength": 10
        },
        "context": {
          "$ref": "#/$defs/prompt_context"
        },
        "focus": {
          "type": "string",
          "description": "技术聚焦点"
        },
        "output_requirements": {
          "$ref": "#/$defs/output_requirements"
        }
      },
      "required": ["instruction", "context", "focus", "output_requirements"]
    },
    "prompt_context": {
      "title": "提示词上下文",
      "type": "object",
      "properties": {
        "paper_info": {
          "$ref": "#/$defs/paper_info"
        },
        "code_info": {
          "$ref": "#/$defs/code_info"
        },
        "dependencies": {
          "type": "array",
          "description": "依赖任务列表",
          "items": {
            "$ref": "#/$defs/dependency_ref"
          },
          "default": []
        },
        "existing_assets": {
          "type": "array",
          "description": "现有资产ID列表",
          "items": {
            "type": "string",
            "pattern": "^(MATH|CODE|SCENARIO|DECISION)_[A-Za-z0-9_]+_[0-9]{2}$"
          },
          "default": []
        }
      },
      "required": ["paper_info", "code_info", "dependencies", "existing_assets"]
    },
    "paper_info": {
      "title": "论文信息",
      "type": "object",
      "properties": {
        "paper_id": {
          "type": "string",
          "description": "论文唯一标识",
          "examples": ["ArXiv:24xx.xxxx", "CVPR 2024"]
        },
        "title": {
          "type": "string",
          "description": "论文标题"
        },
        "pdf_path": {
          "type": "string",
          "description": "本地PDF路径"
        },
        "arxiv_url": {
          "type": "string",
          "format": "uri",
          "description": "ArXiv链接"
        },
        "focus_sections": {
          "type": "array",
          "description": "重点分析章节列表",
          "items": {
            "type": "string"
          },
          "default": []
        }
      },
      "required": ["paper_id", "title"]
    },
    "code_info": {
      "title": "代码信息",
      "type": "object",
      "properties": {
        "repo_url": {
          "type": "string",
          "format": "uri",
          "description": "GitHub仓库URL"
        },
        "branch": {
          "type": "string",
          "description": "分支名称",
          "default": "main"
        },
        "commit_hash": {
          "type": "string",
          "description": "特定commit哈希值"
        },
        "focus_files": {
          "type": "array",
          "description": "重点分析文件列表",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "entry_point": {
          "type": "string",
          "description": "入口文件路径"
        }
      },
      "required": ["repo_url"]
    },
    "dependency_ref": {
      "title": "依赖引用",
      "type": "object",
      "properties": {
        "task_id": {
          "type": "string",
          "description": "依赖任务ID"
        },
        "output_ref": {
          "type": "string",
          "description": "引用的输出字段路径"
        },
        "required": {
          "type": "boolean",
          "description": "是否为必需依赖",
          "default": true
        }
      },
      "required": ["task_id", "output_ref"]
    },
    "output_requirements": {
      "title": "输出要求",
      "type": "object",
      "properties": {
        "atom_type": {
          "type": "string",
          "description": "期望的原子类型",
          "enum": ["Math_Atom", "Code_Atom", "Scenario_Atom", "Strategic_Decision", "Asset_Index"]
        },
        "required_fields": {
          "type": "array",
          "description": "必需字段列表",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "quality_threshold": {
          "type": "string",
          "description": "最低质量等级",
          "enum": ["A", "B", "C", "D"]
        },
        "max_atoms": {
          "type": "integer",
          "description": "最大原子数量",
          "minimum": 1,
          "maximum": 20
        }
      },
      "required": ["atom_type", "quality_threshold", "max_atoms"]
    },
    "constraints": {
      "title": "执行约束",
      "type": "object",
      "properties": {
        "timeout_seconds": {
          "type": "integer",
          "description": "执行超时时间（秒）",
          "minimum": 60,
          "maximum": 3600,
          "default": 300
        },
        "max_tokens": {
          "type": "integer",
          "description": "LLM最大输出token数",
          "minimum": 1000,
          "maximum": 20000,
          "default": 8000
        },
        "temperature": {
          "type": "number",
          "description": "LLM采样温度",
          "minimum": 0,
          "maximum": 1,
          "default": 0.3
        }
      },
      "required": ["timeout_seconds", "max_tokens", "temperature"]
    }
  }
}